<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Magazine Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.9;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #ff6b6b;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .section.active {
            display: block;
        }

        /* Homepage Grid Styles */
        .magazine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .magazine-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .magazine-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.2);
        }

        .magazine-cover {
            width: 100%;
            height: 320px;
            object-fit: cover;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .magazine-info {
            padding: 15px;
        }

        .magazine-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .magazine-date {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .magazine-actions {
            display: flex;
            justify-content: space-between;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Skeleton Loading */
        .skeleton-loader {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .skeleton-cover {
            width: 100%;
            height: 320px;
            background: rgba(255, 255, 255, 0.1);
        }

        .skeleton-info {
            padding: 15px;
        }

        .skeleton-title {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .skeleton-date {
            height: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-bottom: 15px;
            width: 60%;
        }

        .skeleton-actions {
            display: flex;
            justify-content: space-between;
        }

        .skeleton-btn {
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 45%;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* PDF Viewer Styles */
        .pdf-viewer-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: #8a8a8a;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            min-height: 600px;
            padding: 20px;
        }

        .pdf-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: #ff6b6b;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        /* PDF Container */
        .pdf-container {
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        #pdf-canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .pdf-page-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .page-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
        }

        /* Navigation Arrows */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .nav-arrow:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow.left {
            left: 10px;
        }

        .nav-arrow.right {
            right: 10px;
        }

        .bottom-nav {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        .bottom-arrow {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .bottom-arrow:hover {
            background: white;
            transform: scale(1.1);
        }

        /* Upload Section Styles */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-area p {
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .supabase-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .status-connected {
            color: #4CAF50;
        }

        .status-disconnected {
            color: #f44336;
        }

        .magazine-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .cover-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .cover-upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .cover-upload-area i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .cover-preview {
            margin-top: 10px;
            text-align: center;
        }

        .cover-preview img {
            max-width: 200px;
            max-height: 280px;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.8;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .pdf-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
            gap: 20px;
            color: #333;
        }

        .pdf-skeleton {
            width: 300px;
            height: 400px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            margin: 0 auto;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .pdf-viewer-container {
                min-height: 500px;
                padding: 15px 10px;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            .magazine-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .pdf-controls {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .nav-arrow {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .nav-arrow.left {
                left: 5px;
            }
            
            .nav-arrow.right {
                right: 5px;
            }
            
            .bottom-arrow {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .pdf-viewer-container {
                min-height: 400px;
                padding: 10px 5px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .magazine-grid {
                grid-template-columns: 1fr;
            }
            
            .pdf-page-nav {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-arrow {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .bottom-arrow {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Digital Magazine Library</h1>
            <p>Browse your magazine collection or upload new issues</p>
        </header>

        <div class="navigation">
            <button class="nav-btn active" data-section="home">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="nav-btn" data-section="upload">
                <i class="fas fa-upload"></i> Upload
            </button>
        </div>

        <!-- Home Section - Magazine Grid -->
        <section id="home" class="section active">
            <h2>Your Magazine Collection</h2>
            <div class="magazine-grid" id="magazine-grid">
                <!-- Skeleton loading will be added here -->
                <div class="empty-state" id="loading-magazines">
                    <div class="loading"></div> Loading magazines...
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <section id="upload" class="section">
            <h2>Upload New Magazine</h2>
            <p>Select a PDF file and add details to upload to your library</p>
            
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to select a PDF file or drag and drop here</p>
                <p class="file-size">Maximum file size: 50MB</p>
                <input type="file" id="file-input" class="file-input" accept=".pdf">
                <div class="progress-bar" id="upload-progress" style="display: none;">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="magazine-form">
                <div class="form-group">
                    <label for="magazine-title">Magazine Title *</label>
                    <input type="text" id="magazine-title" placeholder="Enter magazine title">
                </div>
                <div class="form-group">
                    <label for="magazine-date">Issue Date *</label>
                    <input type="month" id="magazine-date">
                </div>
                <div class="form-group">
                    <label for="magazine-description">Description</label>
                    <textarea id="magazine-description" placeholder="Enter magazine description"></textarea>
                </div>
                <div class="form-group">
                    <label>Cover Image</label>
                    <div class="cover-upload-area" id="cover-upload-area">
                        <i class="fas fa-image"></i>
                        <p>Click to select a cover image</p>
                        <p class="file-size">Maximum file size: 20MB</p>
                        <input type="file" id="cover-input" class="file-input" accept="image/*">
                    </div>
                    <div class="cover-preview" id="cover-preview">
                        <p>No cover image selected</p>
                    </div>
                </div>
            </div>
            
            <div class="pdf-controls">
                <button class="btn btn-primary" id="upload-btn" disabled>
                    <i class="fas fa-upload"></i> Upload to Library
                </button>
            </div>
            
            <div class="supabase-status">
                <h3>Supabase Status: <span id="supabase-status" class="status-connected">Connected</span></h3>
                <p id="supabase-message">Your magazines are being loaded from Supabase</p>
            </div>
        </section>

        <!-- PDF Viewer Section (hidden by default) -->
        <section id="pdf-viewer" class="section">
            <div class="pdf-controls">
                <button class="btn btn-primary" id="back-to-home">
                    <i class="fas fa-home"></i> Back to Library
                </button>
                <button class="btn btn-success" id="download-pdf">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-out">-</button>
                    <span id="zoom-level">80%</span>
                    <button class="zoom-btn" id="zoom-in">+</button>
                </div>
            </div>

            <div class="pdf-viewer-container">
                <!-- Left Navigation Arrow -->
                <button class="nav-arrow left" id="arrow-left">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <!-- Right Navigation Arrow -->
                <button class="nav-arrow right" id="arrow-right">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <!-- Bottom Navigation Arrows -->
                <div class="bottom-nav">
                    <button class="bottom-arrow" id="bottom-prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="bottom-arrow" id="bottom-next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="pdf-container">
                    <div class="pdf-loading" id="pdf-loading">
                        <div class="pdf-skeleton"></div>
                        <p>Loading your magazine...</p>
                    </div>
                    <canvas id="pdf-canvas" style="display: none;"></canvas>
                </div>
            </div>

            <div class="pdf-page-nav">
                <div class="page-indicator">
                    <span>Page: </span>
                    <span id="current-page">1</span>
                    <span> of </span>
                    <span id="total-pages">0</span>
                </div>
            </div>
        </section>

        <footer>
            <p>Digital Magazine Library &copy; 2023 | Powered by Supabase & PDF.js</p>
        </footer>
    </div>

    <script>
        // Supabase Configuration with your credentials
        const SUPABASE_URL = 'https://rpfyqianbgxdqglcqoqz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwZnlxaWFuYmd4ZHFnbGNxb3F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzAxMjEsImV4cCI6MjA4MDAwNjEyMX0.aRsTpje9YXNrj8HpvUCnRSsfSazpboyJli49424dmV0';
        
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Initialize Supabase
        let supabase;
        let currentPdf = null;
        let currentPageNum = 1;
        let totalPages = 0;
        let scale = 1.5; // Default zoom set to 80%
        let maxScale = 3.0;
        let minScale = 0.3;
        
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase connected successfully");
        } catch (error) {
            console.error("Supabase initialization error:", error);
            document.getElementById('supabase-status').textContent = "Connection Failed";
            document.getElementById('supabase-status').className = "status-disconnected";
            document.getElementById('supabase-message').textContent = "Failed to connect to Supabase. Please check your credentials.";
        }

        document.addEventListener('DOMContentLoaded', function() {
            const navBtns = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');
            const magazineGrid = document.getElementById('magazine-grid');
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const coverUploadArea = document.getElementById('cover-upload-area');
            const coverInput = document.getElementById('cover-input');
            const coverPreview = document.getElementById('cover-preview');
            const uploadBtn = document.getElementById('upload-btn');
            const backToHomeBtn = document.getElementById('back-to-home');
            const uploadProgress = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            
            // PDF Viewer elements
            const pdfCanvas = document.getElementById('pdf-canvas');
            const pdfLoading = document.getElementById('pdf-loading');
            const currentPageEl = document.getElementById('current-page');
            const totalPagesEl = document.getElementById('total-pages');
            const downloadPdfBtn = document.getElementById('download-pdf');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomLevelEl = document.getElementById('zoom-level');
            
            // Arrow navigation elements
            const arrowLeft = document.getElementById('arrow-left');
            const arrowRight = document.getElementById('arrow-right');
            const bottomPrev = document.getElementById('bottom-prev');
            const bottomNext = document.getElementById('bottom-next');
            
            // Form elements
            const magazineTitle = document.getElementById('magazine-title');
            const magazineDate = document.getElementById('magazine-date');
            const magazineDescription = document.getElementById('magazine-description');
            
            let selectedFile = null;
            let selectedCoverFile = null;
            let currentMagazine = null;
            let pdfPageSize = { width: 0, height: 0 };
            
            // Navigation
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    
                    // Update active nav button
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target section
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetSection) {
                            section.classList.add('active');
                        }
                    });
                });
            });
            
            // Load magazines from Supabase with skeleton loading
            async function loadMagazines() {
                if (!supabase) {
                    console.error("Supabase not initialized");
                    magazineGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Supabase connection failed. Please check your credentials.</p></div>';
                    return;
                }
                
                // Show skeleton loading
                showSkeletonLoading();
                
                try {
                    const { data: magazines, error } = await supabase
                        .from('magazines')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('Error loading magazines:', error);
                        magazineGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading magazines. Please check your Supabase configuration.</p></div>';
                        return;
                    }
                    
                    displayMagazines(magazines || []);
                } catch (error) {
                    console.error('Error loading magazines:', error);
                    magazineGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading magazines. Please check your Supabase configuration.</p></div>';
                }
            }
            
            // Show skeleton loading
            function showSkeletonLoading() {
                magazineGrid.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'skeleton-loader';
                    skeleton.innerHTML = `
                        <div class="skeleton-cover"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-date"></div>
                            <div class="skeleton-actions">
                                <div class="skeleton-btn"></div>
                                <div class="skeleton-btn"></div>
                            </div>
                        </div>
                    `;
                    magazineGrid.appendChild(skeleton);
                }
            }
            
            // Display magazines in grid
            function displayMagazines(magazines) {
                magazineGrid.innerHTML = '';
                
                if (magazines.length === 0) {
                    magazineGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h3>No Magazines Yet</h3>
                            <p>Upload your first magazine to get started!</p>
                        </div>
                    `;
                    return;
                }
                
                magazines.forEach(magazine => {
                    const card = document.createElement('div');
                    card.className = 'magazine-card';
                    card.innerHTML = `
                        <img src="${magazine.cover_url || 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80'}" alt="${magazine.title}" class="magazine-cover">
                        <div class="magazine-info">
                            <h3 class="magazine-title">${magazine.title}</h3>
                            <p class="magazine-date">${formatDate(magazine.issue_date)}</p>
                            <div class="magazine-actions">
                                <button class="action-btn read-btn" data-id="${magazine.id}">
                                    <i class="fas fa-book-open"></i> Read
                                </button>
                                <button class="action-btn download-btn" data-id="${magazine.id}">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    `;
                    magazineGrid.appendChild(card);
                });
                
                // Add event listeners to read buttons
                document.querySelectorAll('.read-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const magazineId = this.getAttribute('data-id');
                        openMagazine(magazineId, magazines);
                    });
                });
                
                // Add event listeners to download buttons
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const magazineId = this.getAttribute('data-id');
                        downloadMagazine(magazineId, magazines);
                    });
                });
                
                // Add event listeners to magazine cards
                document.querySelectorAll('.magazine-card').forEach((card, index) => {
                    card.addEventListener('click', function() {
                        const magazineId = magazines[index].id;
                        openMagazine(magazineId, magazines);
                    });
                });
            }
            
            // Format date for display
            function formatDate(dateString) {
                if (!dateString) return 'Unknown Date';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }
            
            // Open magazine in PDF viewer
            async function openMagazine(magazineId, magazines) {
                let magazine;
                
                // If magazines array is provided, use it
                if (magazines) {
                    magazine = magazines.find(m => m.id == magazineId);
                } else {
                    // Otherwise, fetch the magazine from Supabase
                    if (!supabase) return;
                    
                    try {
                        const { data, error } = await supabase
                            .from('magazines')
                            .select('*')
                            .eq('id', magazineId)
                            .single();
                        
                        if (error) {
                            console.error('Error loading magazine:', error);
                            return;
                        }
                        
                        magazine = data;
                    } catch (error) {
                        console.error('Error loading magazine:', error);
                        return;
                    }
                }
                
                if (!magazine) return;
                
                currentMagazine = magazine;
                
                // Show PDF viewer section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === 'pdf-viewer') {
                        section.classList.add('active');
                    }
                });
                
                // Update navigation
                navBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Load and display the PDF
                await loadPdf(magazine.file_url);
            }
            
            // Load PDF using PDF.js with skeleton loading
            async function loadPdf(pdfUrl) {
                try {
                    pdfLoading.style.display = 'flex';
                    pdfCanvas.style.display = 'none';
                    
                    // Load the PDF document
                    const loadingTask = pdfjsLib.getDocument(pdfUrl);
                    currentPdf = await loadingTask.promise;
                    
                    totalPages = currentPdf.numPages;
                    currentPageNum = 1;
                    
                    totalPagesEl.textContent = totalPages;
                    currentPageEl.textContent = currentPageNum;
                    
                    // Get first page to determine page size
                    const firstPage = await currentPdf.getPage(1);
                    const viewport = firstPage.getViewport({ scale: 1 });
                    pdfPageSize = {
                        width: viewport.width,
                        height: viewport.height
                    };
                    
                    // Set default zoom to 80%
                    scale = 0.8;
                    zoomLevelEl.textContent = '80%';
                    
                    // Render first page
                    await renderPage(currentPageNum);
                    
                    pdfLoading.style.display = 'none';
                    pdfCanvas.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    pdfLoading.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading PDF: ${error.message}</p>
                    `;
                }
            }
            
            // Render a specific page with current scale
            async function renderPage(pageNum) {
                if (!currentPdf) return;
                
                try {
                    const page = await currentPdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: scale });
                    
                    const canvas = pdfCanvas;
                    const context = canvas.getContext('2d');
                    
                    // Set canvas to actual PDF page size at current scale
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    await page.render(renderContext).promise;
                    currentPageEl.textContent = pageNum;
                    
                } catch (error) {
                    console.error('Error rendering page:', error);
                }
            }
            
            // PDF navigation
            function goToPrevPage() {
                if (currentPageNum > 1) {
                    currentPageNum--;
                    renderPage(currentPageNum);
                }
            }
            
            function goToNextPage() {
                if (currentPageNum < totalPages) {
                    currentPageNum++;
                    renderPage(currentPageNum);
                }
            }
            
            // Arrow navigation
            arrowLeft.addEventListener('click', goToPrevPage);
            arrowRight.addEventListener('click', goToNextPage);
            bottomPrev.addEventListener('click', goToPrevPage);
            bottomNext.addEventListener('click', goToNextPage);
            
            // Zoom functionality
            zoomInBtn.addEventListener('click', function() {
                if (scale < maxScale) {
                    scale = Math.min(scale + 0.1, maxScale);
                    zoomLevelEl.textContent = Math.round(scale * 100) + '%';
                    renderPage(currentPageNum);
                }
            });
            
            zoomOutBtn.addEventListener('click', function() {
                if (scale > minScale) {
                    scale = Math.max(scale - 0.1, minScale);
                    zoomLevelEl.textContent = Math.round(scale * 100) + '%';
                    renderPage(currentPageNum);
                }
            });
            
            // Download PDF
            downloadPdfBtn.addEventListener('click', function() {
                if (currentMagazine && currentMagazine.file_url) {
                    const link = document.createElement('a');
                    link.href = currentMagazine.file_url;
                    link.download = `${currentMagazine.title}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (currentPdf) {
                    renderPage(currentPageNum);
                }
            });
            
            // Download magazine (from grid)
            async function downloadMagazine(magazineId, magazines) {
                let magazine;
                
                if (magazines) {
                    magazine = magazines.find(m => m.id == magazineId);
                } else {
                    if (!supabase) return;
                    
                    try {
                        const { data, error } = await supabase
                            .from('magazines')
                            .select('*')
                            .eq('id', magazineId)
                            .single();
                        
                        if (error) {
                            console.error('Error loading magazine:', error);
                            return;
                        }
                        
                        magazine = data;
                    } catch (error) {
                        console.error('Error loading magazine:', error);
                        return;
                    }
                }
                
                if (!magazine || !magazine.file_url) {
                    alert('Download URL not available for this magazine.');
                    return;
                }
                
                // Create a temporary link to download the file
                const link = document.createElement('a');
                link.href = magazine.file_url;
                link.download = `${magazine.title}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Back to home button
            backToHomeBtn.addEventListener('click', function() {
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === 'home') {
                        section.classList.add('active');
                    }
                });
                
                // Update navigation
                navBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-section') === 'home') {
                        btn.classList.add('active');
                    }
                });
            });
            
            // File upload handling
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#4CAF50';
                uploadArea.style.background = 'rgba(76, 175, 80, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                uploadArea.style.background = 'transparent';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                uploadArea.style.background = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelection(this.files[0]);
                }
            });
            
            // Cover image upload handling
            coverUploadArea.addEventListener('click', function() {
                coverInput.click();
            });
            
            coverInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleCoverSelection(this.files[0]);
                }
            });
            
            function handleFileSelection(file) {
                if (file.type !== 'application/pdf') {
                    alert('Please select a PDF file.');
                    return;
                }
                
                // File size limit to 50MB
                if (file.size > 50 * 1024 * 1024) {
                    alert('File size exceeds 50MB limit.');
                    return;
                }
                
                selectedFile = file;
                uploadArea.innerHTML = `
                    <i class="fas fa-file-pdf" style="color: #ff6b6b;"></i>
                    <p>${file.name}</p>
                    <p class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
                
                // Enable upload button if form is filled
                if (magazineTitle.value.trim() && magazineDate.value) {
                    uploadBtn.disabled = false;
                }
            }
            
            function handleCoverSelection(file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }
                
                // Cover image size limit to 20MB
                if (file.size > 20 * 1024 * 1024) {
                    alert('Cover image size exceeds 20MB limit.');
                    return;
                }
                
                selectedCoverFile = file;
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    coverPreview.innerHTML = `
                        <img src="${e.target.result}" alt="Cover Preview">
                        <p>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                    `;
                };
                reader.readAsDataURL(file);
            }
            
            // Enable upload button when form is filled
            magazineTitle.addEventListener('input', checkFormValidity);
            magazineDate.addEventListener('input', checkFormValidity);
            
            function checkFormValidity() {
                if (selectedFile && magazineTitle.value.trim() && magazineDate.value) {
                    uploadBtn.disabled = false;
                } else {
                    uploadBtn.disabled = true;
                }
            }
            
            // Upload magazine to Supabase - FIXED COVER UPLOAD
            uploadBtn.addEventListener('click', async function() {
                if (!selectedFile) {
                    alert('Please select a PDF file first.');
                    return;
                }
                
                if (!magazineTitle.value.trim() || !magazineDate.value) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                if (!supabase) {
                    alert('Supabase is not configured. Please add your Supabase configuration.');
                    return;
                }
                
                uploadBtn.innerHTML = '<div class="loading"></div> Uploading...';
                uploadBtn.disabled = true;
                uploadProgress.style.display = 'block';
                progressFill.style.width = '0%';
                
                try {
                    // Step 1: Upload PDF file to Supabase Storage
                    const fileExt = selectedFile.name.split('.').pop();
                    const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                    const filePath = `magazines/${fileName}`;
                    
                    const { data: fileData, error: fileError } = await supabase.storage
                        .from('magazine-files')
                        .upload(filePath, selectedFile);
                    
                    if (fileError) {
                        if (fileError.message.includes('bucket')) {
                            throw new Error('Storage bucket "magazine-files" does not exist. Please create it in your Supabase dashboard.');
                        }
                        throw new Error(`File upload failed: ${fileError.message}`);
                    }
                    
                    progressFill.style.width = '50%';
                    
                    // Step 2: Upload cover image if provided - FIXED VERSION
                    let coverUrl = null;
                    if (selectedCoverFile) {
                        const coverExt = selectedCoverFile.name.split('.').pop();
                        // FIX: Use prefix instead of folder
                        const coverFileName = `cover_${fileName}`;
                        
                        const { data: coverData, error: coverError } = await supabase.storage
                            .from('magazine-files')
                            .upload(coverFileName, selectedCoverFile);
                        
                        if (!coverError) {
                            const { data: coverUrlData } = supabase.storage
                                .from('magazine-files')
                                .getPublicUrl(coverFileName);
                            coverUrl = coverUrlData.publicUrl;
                        } else {
                            console.error('Cover upload error:', coverError);
                        }
                    }
                    
                    progressFill.style.width = '75%';
                    
                    // Step 3: Get public URL for the uploaded file
                    const { data: urlData } = supabase.storage
                        .from('magazine-files')
                        .getPublicUrl(filePath);
                    
                    // Step 4: Save magazine metadata to database
                    const { data: magazineData, error: dbError } = await supabase
                        .from('magazines')
                        .insert([
                            {
                                title: magazineTitle.value.trim(),
                                issue_date: magazineDate.value + '-01',
                                description: magazineDescription.value.trim(),
                                cover_url: coverUrl,
                                file_url: urlData.publicUrl,
                                file_path: filePath
                            }
                        ])
                        .select();
                    
                    if (dbError) {
                        throw new Error(`Database insert failed: ${dbError.message}`);
                    }
                    
                    progressFill.style.width = '100%';
                    
                    // Success
                    uploadBtn.innerHTML = '<i class="fas fa-check"></i> Upload Successful';
                    
                    // Reset form
                    setTimeout(() => {
                        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload to Library';
                        uploadBtn.disabled = false;
                        selectedFile = null;
                        selectedCoverFile = null;
                        magazineTitle.value = '';
                        magazineDate.value = '';
                        magazineDescription.value = '';
                        uploadArea.innerHTML = `
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to select a PDF file or drag and drop here</p>
                            <p class="file-size">Maximum file size: 50MB</p>
                        `;
                        coverPreview.innerHTML = '<p>No cover image selected</p>';
                        uploadProgress.style.display = 'none';
                        
                        // Reload magazines to show the new one
                        loadMagazines();
                        
                        // Go back to home to see the updated collection
                        navBtns.forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.getAttribute('data-section') === 'home') {
                                btn.classList.add('active');
                            }
                        });
                        
                        sections.forEach(section => {
                            section.classList.remove('active');
                            if (section.id === 'home') {
                                section.classList.add('active');
                            }
                        });
                    }, 2000);
                    
                } catch (error) {
                    console.error('Upload failed:', error);
                    uploadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Upload Failed';
                    alert(`Upload failed: ${error.message}`);
                    
                    // Reset after 3 seconds
                    setTimeout(() => {
                        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload to Library';
                        uploadBtn.disabled = false;
                        uploadProgress.style.display = 'none';
                    }, 3000);
                }
            });
            
            // Keyboard navigation for PDF viewer
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight' || e.key === ' ') {
                    goToNextPage();
                } else if (e.key === 'ArrowLeft') {
                    goToPrevPage();
                } else if (e.key === 'Escape') {
                    backToHomeBtn.click();
                }
            });
            
            // Initialize the app
            loadMagazines();
        });
    </script>
</body>
</html>
